<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pidriö – Filtra e Cerca tra gli Ordini</title>
  
<link rel="manifest" href="/bottega-filter/manifest.json">
<link rel="apple-touch-icon" href="/bottega-filter/pidriö.png">
<link rel="icon" href="/bottega-filter/pidriö-favicon.png" type="image/png" sizes="32x32">
<meta name="theme-color" content="#317f43">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Pidriö.png">

<style>
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#fff;color:#111;font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif;font-size:16px;line-height:1.25}
:root{--accent:#0a84ff;--border:#ddd;--soft:#f4f4f6;--highlight:#ffd60a;--radius:22px;--elev:0 10px 24px rgba(0,0,0,.15)}
header{padding:16px 16px 8px;text-align:center}
h1{margin:0 0 6px;font-size:20px;font-weight:900}
.hint{font-size:14px;color:#555}
main{padding:12px 16px 24px;max-width:1100px;margin:0 auto}

.search{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;justify-content:center}
.input{flex:1;min-width:240px;padding:14px;border-radius:999px;border:1px solid var(--border);font-size:16px;background:#fff}
.btn{padding:14px 18px;border-radius:999px;border:none;background:var(--accent);color:#fff;font-weight:900;cursor:pointer}
.btn.secondary{background:#111}

.filters{margin-top:14px;display:flex;flex-direction:column;gap:10px}
.controlsRow{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}

.seg{display:flex;gap:6px;padding:6px;background:var(--soft);border-radius:999px;width:fit-content;max-width:100%}
.seg button{border:none;background:transparent;padding:10px 14px;border-radius:999px;font-weight:900;cursor:pointer;white-space:nowrap}
.seg button.active{background:var(--highlight)}

.tick{display:flex;align-items:center;gap:8px;font-size:14px;font-weight:700}
.tick input{width:18px;height:18px;accent-color:var(--accent)}

.status{margin-top:12px;font-size:12px;color:#555;text-align:center}
.errorBox{display:none;margin:10px auto 0;max-width:900px;text-align:left;background:#fff5f5;border:1px solid #ffd6d6;border-radius:14px;padding:10px 12px;color:#8a1f1f;font-size:12px}
.errorBox pre{margin:8px 0 0;white-space:pre-wrap;word-break:break-word;color:#5c1515}
.errorBox b{display:block;margin-bottom:4px}
.status .linklike{border:none;background:none;padding:0;margin-left:.25rem;color:var(--accent);text-decoration:underline;cursor:pointer;font:inherit}

.results{margin-top:18px;display:flex;flex-direction:column;gap:10px}
.order{display:flex;gap:12px;padding:12px;border-radius:26px;background:#fff;border:1px solid rgba(0,0,0,.08);box-shadow:var(--elev);cursor:pointer;transition:transform .06s ease;min-height:54px}
.order:active{transform:scale(.995)}
.badge{min-width:46px;height:32px;background:var(--highlight);border-radius:999px;display:inline-flex;align-items:center;justify-content:center;font-weight:900;color:#000}
.name{font-weight:900}
.sub{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
.pill{font-size:11px;padding:4px 8px;border-radius:999px;background:var(--soft);font-weight:700}
.pill.dept{background:#111;color:#fff}
.snippet{margin-top:8px;font-size:13px;color:#222;background:#fafafa;border:1px solid #eee;border-radius:12px;padding:8px 10px}
mark{background:rgba(255,214,10,.55);padding:0 .15em;border-radius:.25em;font-weight:900}
.empty{padding:16px;border:1px dashed var(--border);border-radius:12px;color:#666;text-align:center}

/* Chip filtro (icona che si espande) */
.chipbar{display:flex;align-items:center;gap:8px;padding:6px;border:1px solid rgba(0,0,0,.06);background:#f7f7f8;border-radius:999px;box-sizing:border-box}
#chipbar-filter{width:auto;cursor:pointer;user-select:none}
#chipbar-filter .chip-inner{display:inline-flex;align-items:center;gap:8px;min-height:40px;max-height:40px;border-radius:999px}
#chipbar-filter.compact .chip-inner{background:#f2f2f3;border:1px solid rgba(0,0,0,.06);border-radius:999px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;padding:0}
#chipbar-filter.compact #filter-badge{opacity:0;width:0;pointer-events:none}
#chipbar-filter.compact svg{color:#111;width:18px;height:18px}
#chipbar-filter.active{display:inline-flex;background:#f7f7f8;border-color:rgba(0,0,0,.06);align-self:center;width:auto}
#chipbar-filter.active .chip-inner{background:#000;color:#fff;border:1px solid #000;padding:0 8px;gap:4px;justify-content:center;align-items:center}
#chipbar-filter.active .chip-inner svg{display:inline-block;width:18px;height:18px;color:var(--highlight);margin-right:3px}
.count-badge{display:none;align-items:center;justify-content:center;padding:0 12px;height:28px;background:var(--highlight);color:#000;border-radius:999px;font-weight:900;font-size:14px}
#chipbar-filter.active #filter-badge{display:inline-flex}

/* MODAL */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:2147483647}
.modal.open{display:block}
.sheet{background:#fff;width:100%;height:100%;padding:16px;overflow:auto}
.close{border:none;background:#111;color:#fff;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer}
.modalTitle{margin:14px 0 6px;font-size:22px;font-weight:900}
.modalSub{margin:0 0 12px;color:#555;font-size:14px}
.kv{width:100%;border-collapse:collapse}
.kv th,.kv td{text-align:left;padding:10px 8px;border-bottom:1px solid #f1f1f1;font-size:15px;vertical-align:top}
.kv th{width:36%;color:#444;font-weight:900}
.kv tr.hl{background:rgba(255,214,10,.18)}
</style>
</head>
<body>
<header>
  <div id="lottie-search" aria-hidden="true" style="width:300px;height:300px;margin:0 auto 6px"></div>
  <h1>Cerca negli Ordini</h1>
  <div class="hint">Cerca il prodotto su cui vuoi avere più info</div>
</header>

<main>
  <div class="search">
    <input id="q" class="input" type="search" autocomplete="off" />
  </div>

  <div class="filters">
    <div class="controlsRow">
      <div class="seg" role="tablist" aria-label="Selettore periodo">
        <button data-mode="next" class="active" type="button">Tutti</button>
        <button data-mode="today" type="button">Oggi</button>
        <button data-mode="tomorrow" type="button">Domani</button>
        <button data-mode="date" type="button">Data</button>
      </div>

      <input type="date" id="filterDate" class="input" style="display:none; max-width:260px;">

      <div class="chipbar compact" id="chipbar-filter" title="Filtro reparti" aria-haspopup="dialog" aria-expanded="false">
        <div class="chip-inner">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <g fill="currentColor">
              <rect x="3" y="6" rx="1.5" ry="1.5" width="18" height="2"></rect>
              <rect x="6" y="11" rx="1.5" ry="1.5" width="12" height="2"></rect>
              <rect x="9" y="16" rx="1.5" ry="1.5" width="6" height="2"></rect>
            </g>
          </svg>
          <span id="filter-badge" class="count-badge"></span>
        </div>
      </div>

      <label class="tick" title="Se attivo, include anche gli ordini di ieri e precedenti">
        <input type="checkbox" id="tickIncludePast">
        Includi ordini passati
      </label>
    </div>
  </div>

  <div id="status" class="status"></div>
  <div id="errorBox" class="errorBox"><b>Errore caricamento</b><div id="errorMsg"></div><pre id="errorDetails"></pre></div>
  <div id="out" class="results">
    <div class="empty">Pronto. Seleziona periodo e/o cerca.</div>
  </div>
</main>

<!-- Modale dettaglio ordine -->
<div id="modal" class="modal" aria-hidden="true" role="dialog">
  <div class="sheet">
    <button class="close" id="mClose" type="button">Chiudi</button>
    <div class="modalTitle" id="mTitle">Dettaglio ordine</div>
    <div class="modalSub" id="mSub"></div>
    <table class="kv" id="mTable"></table>
  </div>
</div>

<!-- Modale filtri reparti -->
<div id="filterModal" class="modal" aria-hidden="true" role="dialog">
  <div class="sheet" style="max-width:min(560px,92vw);max-height:80vh;margin:10vh auto;border-radius:var(--radius);overflow:hidden;border:1px solid rgba(0,0,0,.08);box-shadow:var(--elev)">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px 12px;border-bottom:1px solid #ececec;position:sticky;top:0;background:#fff;z-index:1">
      <div style="font-weight:900;font-size:18px">Filtra reparti</div>
      <button class="close" id="fClose" type="button">Chiudi</button>
    </div>
    <div style="padding:14px 16px 18px;overflow:auto">
      <div id="deptList" style="display:flex;flex-direction:column;gap:10px"></div>
      <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap">
        <button id="fClear" class="btn secondary" type="button" style="flex:1;min-width:160px">Azzera</button>
        <button id="fApply" class="btn" type="button" style="flex:1;min-width:160px">Applica</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js"></script>
<script>
(() => {
  // Fail-safe: mostra errori JS (utile se i selettori "non vanno" perché lo script si ferma)
  const __showRuntimeError = (title, detail) => {
    try{
      const eb = document.getElementById('errorBox');
      const em = document.getElementById('errorMsg');
      const ed = document.getElementById('errorDetails');
      if(!eb || !em || !ed) return;
      eb.style.display = 'block';
      em.textContent = title;
      ed.textContent = detail || '';
    }catch(_){/* ignore */}
  };
  window.addEventListener('error', (e)=>{
    const msg = e?.message || 'Errore JavaScript';
    const where = `${e?.filename||''}:${e?.lineno||''}:${e?.colno||''}`;
    __showRuntimeError(msg, where);
  });
  window.addEventListener('unhandledrejection', (e)=>{
    const reason = e?.reason?.message || String(e?.reason||'Promise rejection');
    __showRuntimeError('Errore Promise', reason);
  });

  // Lottie init
  try{
    lottie.loadAnimation({
      container: document.getElementById('lottie-search'),
      renderer: 'svg',
      loop: true,
      autoplay: true,
      path: 'searching.json'
    });
  }catch(_){/* lottie opzionale */}

  // ====== CONFIG ======
  const API_URL = 'https://script.google.com/macros/s/AKfycbzp_2RNQO9ROQkpcGebBpZ9P_MyZEmxkqLh5G-ODe4Yo2x9E0aRbEQIbmofaxhod9VGFA/exec';

  // Modal dettaglio: "all" = tutte le colonne, "items" = solo righe prodotto + note
  const DETAIL_MODE = 'all';

  // ===== Utils =====
  const esc = (s) => String(s ?? '').replace(/[&<>\"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[m]||m));
  const norm = (s) => (s||'')
    .toLowerCase()
    .normalize('NFD').replace(/\p{Diacritic}/gu,'')
    .replace(/\s+/g,' ')
    .trim();

  const pad2 = n => String(n).padStart(2,'0');
  const ymd = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const ddmmyyyy = d => `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;

  const truthy = (v) => {
    if(v == null) return false;
    const s = norm(String(v));
    if(!s) return false;
    if(['0','no','n','false','falso'].includes(s)) return false;
    if(['1','si','sì','yes','y','true','ok'].includes(s)) return true;
    const n = Number(String(v).replace(',', '.'));
    return Number.isFinite(n) && n > 0;
  };

  function todayLocal(){ const d=new Date(); d.setHours(12,0,0,0); return d; }

  function parseAnyDate(s){
    if(!s) return null;
    const str = String(s).trim();
    let m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
    if(m){
      const dd=+m[1], mm=+m[2]-1, yy=+m[3];
      return new Date(yy<100?2000+yy:yy, mm, dd, 12,0,0);
    }
    m = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(m) return new Date(+m[1], +m[2]-1, +m[3], 12,0,0);
    const d = new Date(str);
    return Number.isNaN(d.getTime()) ? null : d;
  }

  const pickKey = (obj, cands) => {
    const ks = Object.keys(obj||{});
    for(const c of cands){ const k = ks.find(x => norm(x) === norm(c)); if(k) return k; }
    for(const c of cands){ const k = ks.find(x => norm(x).includes(norm(c))); if(k) return k; }
    return null;
  };

  function mapRowsFromAPI(rows){
    const out=[];
    for(const r of (rows||[])){
      if(!r || typeof r !== 'object') continue;
      const nameKey = pickKey(r,['NOME CLIENTE','NOME','CLIENTE']);
      const dateKeyRaw = pickKey(r,['DATA ORDINE','DATA','GIORNO','DATA RITIRO','RITIRO']);
      const timeKey = pickKey(r,['ORA','ORARIO']);
      const ordKey  = pickKey(r,['NUMERO ORDINE','ORDINE','N° ORDINE','ORD']);

      const name = nameKey ? String(r[nameKey]||'').trim() : '';
      if(!name) continue;

      const d = dateKeyRaw ? parseAnyDate(r[dateKeyRaw]) : null;
      const time = timeKey ? String(r[timeKey]||'').trim() : '';
      const ordRaw = ordKey ? r[ordKey] : r.ord;
      const ord = (ordRaw!=null && ordRaw!=='') ? Number(ordRaw) : null;

      out.push({
        ord: Number.isFinite(ord) ? ord : null,
        name,
        dateObj: d,
        dateKey: d ? ymd(d) : null,
        dateText: d ? ddmmyyyy(d) : '',
        time,
        src: r
      });
    }
    return out;
  }

  function buildSearchBlob(row){
    const parts = [];
    parts.push(row.ord!=null ? String(row.ord) : '');
    parts.push(row.name||'');
    parts.push(row.dateText||'');
    parts.push(row.time||'');
    for(const [k,v] of Object.entries(row.src||{})){
      parts.push(String(k));
      if(v==null) continue;
      parts.push(typeof v === 'string' ? v : JSON.stringify(v));
    }
    return norm(parts.join(' • '));
  }

  function extractNotes(row){
    const k = pickKey(row.src||{}, ['NOTE SULL\'ORDINE','NOTE SULL ORDINE','NOTE','ANNOTAZIONI','RICHIESTE SPECIALI','RICHIESTE','ALLERGIE']);
    return k ? String(row.src[k]||'').trim() : '';
  }

  function extractItemsText(row){
    const lines=[];
    for(const [k,v] of Object.entries(row.src||{})){
      const kk = String(k||'');
      if(/^\s*\d+\)\s*/.test(kk)){
        const val = String(v??'').trim();
        if(val && val!=='0') lines.push(`${kk} ${val}`);
      }
    }
    return lines.join(' • ').trim();
  }

  function extractDepts(row){
    const src = row.src || {};

    const repKey = pickKey(src, ['REPARTI','REPARTO','REPARTI RICHIESTI','REPARTI ORDINE','REPARTI (AUTO)','REPARTI (CALCOLATI)']);
    if(repKey){
      const raw0 = String(src[repKey]||'').trim();
      if(raw0){
        const raw = raw0.replace(/\n/g, ',');
        const parts = raw.split(/[,;|]+/g).map(s=>s.trim()).filter(Boolean);
        return Array.from(new Set(parts));
      }
    }

    const KNOWN = [
      'Carne','Frutta e Verdura','Frutta','Verdura','Pesce','Gastronomia','Panetteria','Salumi','Formaggi',
      'Dolci','Avicoli','Uova','Latte','Vini','Bevande','Altro'
    ];

    const found = [];
    for(const [k,v] of Object.entries(src)){
      const key = String(k||'').trim();
      if(!key) continue;
      const hit = KNOWN.find(d => norm(key) === norm(d) || norm(key).includes(norm(d)));
      if(!hit) continue;
      if(!truthy(v)) continue;
      found.push(hit);
    }

    return Array.from(new Set(found));
  }

  function highlightSnippet(text, qNorm){
    if(!qNorm) return '';
    const raw = String(text||'');
    const n = norm(raw);
    const idx = n.indexOf(qNorm);
    if(idx < 0) return '';
    const left = Math.max(0, idx - 60);
    const right = Math.min(raw.length, idx + 60);
    const slice = raw.slice(left, right);
    const re = new RegExp(qNorm.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'ig');
    return esc(slice).replace(re, (m)=>`<mark>${esc(m)}</mark>`);
  }

  function looksLikeHtml(s){
    const t = (s||'').trim().slice(0,200).toLowerCase();
    return t.startsWith('<!doctype') || t.startsWith('<html') || t.includes('<head') || t.includes('<body');
  }

  function extractJsonFromText(raw){
    const text = (raw||'').trim();
    if(!text) throw new Error('Risposta vuota');
    if(text.startsWith('{') || text.startsWith('[')) return JSON.parse(text);
    const s = text.search(/[\[{]/);
    const eB = text.lastIndexOf('}');
    const eA = text.lastIndexOf(']');
    const e = Math.max(eB, eA);
    if(s !== -1 && e > s) return JSON.parse(text.slice(s, e+1));
    throw new Error('Non trovo JSON nella risposta');
  }

  // ===== UI =====
  const out = document.getElementById('out');
  const status = document.getElementById('status');
  const errorBox = document.getElementById('errorBox');
  const errorMsg = document.getElementById('errorMsg');
  const errorDetails = document.getElementById('errorDetails');
  const qEl = document.getElementById('q');
  const filterDateEl = document.getElementById('filterDate');
  const chipFilterEl = document.getElementById('chipbar-filter');
  const filterBadgeEl = document.getElementById('filter-badge');
  const tickIncludePastEl = document.getElementById('tickIncludePast');
  const tabs = Array.from(document.querySelectorAll('.seg button'));

  // Modale dettaglio
  const modal = document.getElementById('modal');
  const mClose = document.getElementById('mClose');
  const mTitle = document.getElementById('mTitle');
  const mSub = document.getElementById('mSub');
  const mTable = document.getElementById('mTable');

  // Modale filtri
  const filterModal = document.getElementById('filterModal');
  const deptList = document.getElementById('deptList');
  const fClose = document.getElementById('fClose');
  const fApply = document.getElementById('fApply');
  const fClear = document.getElementById('fClear');

  let PERIOD_MODE = 'next';
  let LAST_FETCH = { url:'', status:0, ok:false, raw:'' };
  let DATA = [];
  let SELECTED_DEPTS = new Set();
  let PENDING_DEPTS = new Set();

  // ===== Modal helpers =====
  function openModal(row, qNorm){
    mTitle.textContent = row.name || 'Dettaglio ordine';
    mSub.textContent = [
      row.ord ? `Ordine #${row.ord}` : null,
      row.dateText || null,
      row.time || null,
      (row.__depts && row.__depts.length) ? `Reparti: ${row.__depts.join(', ')}` : null
    ].filter(Boolean).join(' • ');

    const entries = Object.entries(row.src||{});
    const skipKeys = new Set([
      'ord','numero ordine (parsed)','ora (parsed)','zona (parsed)',
      'nome','nome cliente','cliente','data','giorno','data ordine','data ritiro','ritiro','ora','orario'
    ].map(k=>norm(k)));

    const rows = [];
    let seenItemsStart = false;

    for(const [k,v] of entries){
      const keyStr = String(k).trim();
      if(skipKeys.has(norm(keyStr))) continue;

      if(DETAIL_MODE === 'items'){
        const isItem = /^\s*\d+\)\s*/.test(keyStr);
        const isNotes = ['note sull\'ordine','note sull ordine','note','annotazioni','richieste speciali','richieste','allergie']
          .some(x => norm(keyStr).includes(norm(x)));
        if(!isItem && !isNotes) continue;
      }

      const valStr = (v==null)? '' : String(v).trim();
      if(/^\s*1\)\s*/i.test(keyStr)) seenItemsStart=true;
      const shouldHL = seenItemsStart && valStr!=='' && valStr!=='0';
      const matchHL = qNorm && norm(keyStr+' '+valStr).includes(qNorm);
      rows.push(`<tr class="${(shouldHL||matchHL)?'hl':''}"><th>${esc(keyStr)}</th><td>${esc(valStr)}</td></tr>`);
    }

    mTable.innerHTML = rows.join('') || `<tr><td>Nessun dettaglio</td></tr>`;
    modal.classList.add('open');
    modal.setAttribute('aria-hidden','false');
  }

  function closeModal(){
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden','true');
  }

  mClose.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeModal(); });

  // ===== Dept filter chip =====
  function syncFilterChip(){
    const n = SELECTED_DEPTS.size;
    if(n <= 0){
      chipFilterEl.classList.add('compact');
      chipFilterEl.classList.remove('active');
      filterBadgeEl.textContent = '';
      return;
    }
    chipFilterEl.classList.remove('compact');
    chipFilterEl.classList.add('active');
    filterBadgeEl.textContent = String(n);
  }

  function renderDeptModal(depts){
    if(!depts.length){
      deptList.innerHTML = '<div class="empty">Nessun reparto rilevato nei dati.</div>';
      return;
    }

    deptList.innerHTML = depts.map(d=>{
      const id = 'dep-' + norm(d).replace(/[^a-z0-9]+/g,'-');
      return `
        <label for="${esc(id)}" style="display:flex;align-items:center;gap:10px;padding:6px 2px;cursor:pointer">
          <input id="${esc(id)}" type="checkbox" value="${esc(d)}" style="width:20px;height:20px;accent-color:var(--accent)" />
          <span style="font-weight:800">${esc(d)}</span>
        </label>`;
    }).join('');

    Array.from(deptList.querySelectorAll('input[type="checkbox"]')).forEach(cb=>{
      cb.checked = PENDING_DEPTS.has(cb.value);
      cb.addEventListener('change', ()=>{
        if(cb.checked) PENDING_DEPTS.add(cb.value);
        else PENDING_DEPTS.delete(cb.value);
      });
    });
  }

  function openFilterModal(){
    PENDING_DEPTS = new Set(SELECTED_DEPTS);
    Array.from(deptList.querySelectorAll('input[type="checkbox"]')).forEach(cb=>{
      cb.checked = PENDING_DEPTS.has(cb.value);
    });
    filterModal.classList.add('open');
    filterModal.setAttribute('aria-hidden','false');
    chipFilterEl.setAttribute('aria-expanded','true');
  }

  function closeFilterModal(){
    filterModal.classList.remove('open');
    filterModal.setAttribute('aria-hidden','true');
    chipFilterEl.setAttribute('aria-expanded','false');
  }

  chipFilterEl.addEventListener('click', ()=>{
    try{ openFilterModal(); }
    catch(e){
      const msg = e?.message || String(e);
      errorBox.style.display = 'block';
      errorMsg.textContent = 'Errore filtro reparti';
      errorDetails.textContent = msg;
    }
  });
  fClose.addEventListener('click', closeFilterModal);
  filterModal.addEventListener('click', (e)=>{ if(e.target === filterModal) closeFilterModal(); });

  fClear.addEventListener('click', ()=>{
    PENDING_DEPTS = new Set();
    Array.from(deptList.querySelectorAll('input[type="checkbox"]')).forEach(cb=>cb.checked=false);
  });

  fApply.addEventListener('click', ()=>{
    SELECTED_DEPTS = new Set(PENDING_DEPTS);
    syncFilterChip();
    closeFilterModal();
    runSearch();
  });

  // ===== Period logic =====
  function enforceIncludePastConstraints(){
    const todayKey = ymd(todayLocal());
    if(!tickIncludePastEl.checked){
      filterDateEl.min = todayKey;
      if(PERIOD_MODE === 'date' && filterDateEl.value && filterDateEl.value < todayKey){
        filterDateEl.value = todayKey;
      }
    } else {
      filterDateEl.min = '';
    }
  }

  function setPeriodMode(mode){
    PERIOD_MODE = mode;
    tabs.forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
    const showDate = (mode === 'date');
    filterDateEl.style.display = showDate ? '' : 'none';
    if(showDate && !filterDateEl.value) filterDateEl.value = ymd(todayLocal());
    enforceIncludePastConstraints();
    runSearch();
  }

  tabs.forEach(b => b.addEventListener('click', ()=>{
    try{ setPeriodMode(b.dataset.mode); }
    catch(e){
      const msg = e?.message || String(e);
      errorBox.style.display = 'block';
      errorMsg.textContent = 'Errore selettore periodo';
      errorDetails.textContent = msg;
    }
  }));

  function refreshDeptOptions(){
    const set = new Set();
    for(const r of DATA){
      for(const d of (r.__depts || [])) set.add(d);
    }
    const depts = Array.from(set).sort((a,b)=>a.localeCompare(b,'it',{sensitivity:'base'}));
    SELECTED_DEPTS = new Set(Array.from(SELECTED_DEPTS).filter(d => set.has(d)));
    PENDING_DEPTS = new Set(SELECTED_DEPTS);
    syncFilterChip();
    renderDeptModal(depts);
  }

  async function fetchAPI(){
    const url = API_URL + (API_URL.includes('?') ? '&' : '?') + '_ts=' + Date.now();
    errorBox.style.display = 'none';
    errorMsg.textContent = '';
    errorDetails.textContent = '';
    status.textContent = 'Carico ordini…';

    let res, raw;
    try{
      res = await fetch(url, {
        method: 'GET',
        mode: 'cors',
        cache: 'no-store',
        redirect: 'follow',
        credentials: 'omit',
        headers: { 'Accept': 'application/json, text/plain, */*' }
      });
      raw = await res.text();
      LAST_FETCH = { url, status: res.status, ok: res.ok, raw: String(raw||'') };
    } catch (_e){
      throw new Error('Fetch fallita (rete/CORS).');
    }

    if(looksLikeHtml(raw)){
      throw new Error('L’API sta tornando HTML (probabile permessi/deploy).');
    }

    if(!res.ok){
      throw new Error(`HTTP ${res.status}: risposta non valida`);
    }

    let data;
    try{ data = extractJsonFromText(raw); }
    catch(_e){ throw new Error('Parse JSON fallita.'); }

    let rows=[];
    if(Array.isArray(data)) rows=data;
    else if(Array.isArray(data.rows)) rows=data.rows;
    else if(Array.isArray(data.data)) rows=data.data;
    else if(data && typeof data==='object'){
      const k = Object.keys(data).find(x=>Array.isArray(data[x]) && (data[x].length===0 || typeof data[x][0]==='object'));
      if(k) rows=data[k];
    }
    if(!Array.isArray(rows)) rows=[];

    DATA = mapRowsFromAPI(rows);
    for(const r of DATA){
      r.__blobAll = buildSearchBlob(r);
      r.__notesRaw = extractNotes(r);
      r.__itemsRaw = extractItemsText(r);
      r.__depts = extractDepts(r);
    }

    refreshDeptOptions();
    enforceIncludePastConstraints();

    status.innerHTML = `Ordini caricati: <b>${DATA.length + 1}</b> • <button class="linklike" id="refreshNow" type="button">aggiorna</button>`;
    const btn = document.getElementById('refreshNow');
    if(btn) btn.onclick = async ()=>{
      try{ await fetchAPI(); runSearch(); }
      catch(e){
        const msg = (e && (e.message||String(e))) || 'Errore sconosciuto';
        status.textContent = 'Errore nel caricamento dati.';
        errorBox.style.display = 'block';
        errorMsg.textContent = msg;
        const sample = (LAST_FETCH.raw||'').slice(0, 400);
        errorDetails.textContent = `URL: ${LAST_FETCH.url || '(n/d)'}\nHTTP: ${LAST_FETCH.status || '(n/d)'}\nRisposta (inizio):\n${sample}`;
      }
    };
  }

  function applyPeriodAndDeptFilters(){
    const t = todayLocal();
    const todayKey = ymd(t);
    const tom = new Date(t); tom.setDate(t.getDate()+1);
    const tomorrowKey = ymd(tom);

    let pool = DATA;

    // Se NON includi ordini passati: nascondi ieri e precedenti (quindi mostra da oggi in poi)
    if(!tickIncludePastEl.checked){
      pool = pool.filter(r => r.dateKey && r.dateKey >= todayKey);
    }

    if(PERIOD_MODE === 'next'){
      pool = pool.filter(r => r.dateKey && r.dateKey >= todayKey);
    }else if(PERIOD_MODE === 'today'){
      pool = pool.filter(r => r.dateKey === todayKey);
    }else if(PERIOD_MODE === 'tomorrow'){
      pool = pool.filter(r => r.dateKey === tomorrowKey);
    }else if(PERIOD_MODE === 'date'){
      const sel = (filterDateEl.value || '').trim();
      if(sel) pool = pool.filter(r => r.dateKey === sel);
    }

    if(SELECTED_DEPTS.size){
      const selectedNorm = new Set(Array.from(SELECTED_DEPTS).map(d=>norm(d)));
      pool = pool.filter(r => (r.__depts||[]).some(d => selectedNorm.has(norm(d))));
    }

    return pool;
  }

  function runSearch(){
    const q = norm(qEl.value);
    const pool = applyPeriodAndDeptFilters();
    const hits = q ? pool.filter(r => r.__blobAll && r.__blobAll.includes(q)) : pool.slice();

    if(hits.length === 0){
      out.innerHTML = `<div class="empty">Nessun ordine nel periodo selezionato.</div>`;
      return;
    }

    hits.sort((a,b)=>{
      // Ordine risultati:
      // - Se "Includi ordini passati" è OFF (default): dal più vicino (oggi) al più lontano (futuro)
      // - Se ON: per vicinanza a oggi (|diff giorni| crescente), poi per data (passato->futuro), poi per numero ordine
      const t = todayLocal();
      const ta = a.dateObj ? Math.round((a.dateObj - t) / 86400000) : 999999;
      const tb = b.dateObj ? Math.round((b.dateObj - t) / 86400000) : 999999;

      if(!tickIncludePastEl.checked){
        // oggi (0) prima, poi futuro (1,2,3...)
        if(ta !== tb) return ta - tb;
      } else {
        // vicinanza assoluta a oggi
        const aa = Math.abs(ta);
        const bb = Math.abs(tb);
        if(aa !== bb) return aa - bb;
        // a parità di distanza: passato prima del futuro (es. ieri prima di domani)
        if(ta !== tb) return ta - tb;
      }

      // Bonus: se c'è una query, spingi in alto chi matcha nelle NOTE
      if(q){
        const an = norm(a.__notesRaw||'').includes(q) ? 1 : 0;
        const bn = norm(b.__notesRaw||'').includes(q) ? 1 : 0;
        if(an!==bn) return bn-an;
      }

      // a parità: più recente numero ordine prima
      return (b.ord||0) - (a.ord||0);
    });

    out.innerHTML = hits.map(r=>{
      const num = r.ord!=null ? r.ord : '—';
      const deptPills = (r.__depts||[]).slice(0,2).map(d => `<span class="pill dept">${esc(d)}</span>`);
      const extra = (r.__depts||[]).length > 2 ? `<span class="pill">+${(r.__depts||[]).length-2}</span>` : '';

      const pills = [
        r.dateText ? `<span class="pill">${esc(r.dateText)}</span>` : '',
        r.time ? `<span class="pill">${esc(r.time)}</span>` : '',
        ...deptPills,
        extra
      ].filter(Boolean).join('');

      let snippet = '';
      if(q){
        const s1 = highlightSnippet(r.__notesRaw || '', q);
        const s2 = highlightSnippet(r.__itemsRaw || '', q);
        snippet = s1 || s2;
      }

      return `
        <div class="order" tabindex="0" role="button">
          <div class="badge">${esc(num)}</div>
          <div style="flex:1;min-width:0">
            <div class="name">${esc(r.name)}</div>
            <div class="sub">${pills}</div>
            ${snippet ? `<div class="snippet">${snippet}</div>` : ``}
          </div>
        </div>`;
    }).join('');

    Array.from(out.querySelectorAll('.order')).forEach((card, idx)=>{
      const row = hits[idx];
      card.addEventListener('click', ()=>openModal(row, norm(qEl.value)));
      card.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' || e.key===' '){
          e.preventDefault();
          openModal(row, norm(qEl.value));
        }
      });
    });
  }

  // ===== Events =====
  qEl.addEventListener('input', ()=>{ runSearch(); });
  filterDateEl.addEventListener('change', ()=>{
    try{ runSearch(); }
    catch(e){
      errorBox.style.display='block';
      errorMsg.textContent='Errore selettore data';
      errorDetails.textContent=e?.message||String(e);
    }
  });
  tickIncludePastEl.addEventListener('change', ()=>{
    try{ enforceIncludePastConstraints(); runSearch(); }
    catch(e){
      errorBox.style.display='block';
      errorMsg.textContent='Errore checkbox';
      errorDetails.textContent=e?.message||String(e);
    }
  });

  // ===== Boot =====
  (async function init(){
    try{
      await fetchAPI();
      tickIncludePastEl.checked = false;
      setPeriodMode('next');
      syncFilterChip();
      runSearch();
      qEl.focus();
    } catch (err){
      const msg = (err && (err.message||String(err))) || 'Errore sconosciuto';
      status.textContent = 'Errore nel caricamento dati.';
      out.innerHTML = `<div class="empty">API non raggiungibile o risposta non valida.</div>`;
      errorBox.style.display = 'block';
      errorMsg.textContent = msg;
      const sample = (LAST_FETCH.raw||'').slice(0, 400);
      errorDetails.textContent = `URL: ${LAST_FETCH.url || '(n/d)'}\nHTTP: ${LAST_FETCH.status || '(n/d)'}\nRisposta (inizio):\n${sample}`;
    }
  })();
})();
</script>
</body>
</html>
